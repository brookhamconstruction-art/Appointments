<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>My Appointments</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .today-date {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .input-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        #appointmentInput {
            flex: 1;
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
        }

        #appointmentInput:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voice-btn {
            background: #667eea;
            color: white;
            min-width: 60px;
        }

        .voice-btn:active {
            background: #5568d3;
        }

        .voice-btn.listening {
            background: #ef4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .add-btn {
            background: #10b981;
            color: white;
        }

        .add-btn:active {
            background: #059669;
        }

        .helper-text {
            color: #666;
            font-size: 14px;
            margin-top: 8px;
        }

        .appointments-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 16px;
            color: #333;
        }

        .appointment-item {
            background: #f9fafb;
            border-left: 4px solid #667eea;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appointment-item.upcoming {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .appointment-item.past {
            opacity: 0.6;
            border-left-color: #9ca3af;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .appointment-time {
            color: #666;
            font-size: 0.9em;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .delete-btn:active {
            background: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .debug-info {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“… My Appointments</h1>
            <div class="today-date" id="todayDate"></div>
        </div>

        <div id="debugInfo" class="debug-info" style="display: none;"></div>

        <div class="input-section">
            <div class="input-group">
                <input 
                    type="text" 
                    id="appointmentInput" 
                    placeholder="meeting with Laurie Friday at 2pm"
                />
                <button class="voice-btn" id="voiceBtn">ðŸŽ¤</button>
                <button class="add-btn" id="addBtn">Add</button>
            </div>
            <div class="helper-text">
                ðŸ’¡ Try: "dentist tomorrow 3pm" or "call mom Tuesday 5"
            </div>
        </div>

        <div class="appointments-section">
            <h2 class="section-title">Upcoming Appointments</h2>
            <div id="appointmentsList"></div>
        </div>
    </div>

    <script>
        // Global state
        let appointments = [];
        let recognition = null;
        let debugMode = true;

        // Debug logging
        function debug(message) {
            console.log(message);
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.style.display = 'block';
                debugDiv.textContent = message;
            }
        }

        // Initialize app
        function init() {
            debug('App starting...');
            
            // Test localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                debug('âœ“ Storage working');
            } catch (e) {
                debug('âœ— Storage blocked: ' + e.message);
            }

            loadAppointments();
            updateTodayDate();
            renderAppointments();
            setupEventListeners();
            initVoiceRecognition();
            
            debug('âœ“ App ready');
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('addBtn').addEventListener('click', addAppointment);
            document.getElementById('appointmentInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addAppointment();
            });
            document.getElementById('voiceBtn').addEventListener('click', toggleVoice);
        }

        // Update date display
        function updateTodayDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', options);
        }

        // Voice recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('appointmentInput').value = transcript;
                    stopVoice();
                };
                
                recognition.onerror = function(event) {
                    debug('Voice error: ' + event.error);
                    stopVoice();
                };
                
                recognition.onend = stopVoice;
            } else {
                document.getElementById('voiceBtn').style.display = 'none';
            }
        }

        function toggleVoice() {
            const btn = document.getElementById('voiceBtn');
            if (btn.classList.contains('listening')) {
                stopVoice();
            } else {
                startVoice();
            }
        }

        function startVoice() {
            if (!recognition) return;
            const btn = document.getElementById('voiceBtn');
            btn.classList.add('listening');
            btn.textContent = 'ðŸ”´';
            try {
                recognition.start();
            } catch (e) {
                debug('Voice start error: ' + e.message);
                stopVoice();
            }
        }

        function stopVoice() {
            const btn = document.getElementById('voiceBtn');
            btn.classList.remove('listening');
            btn.textContent = 'ðŸŽ¤';
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    // Ignore errors when stopping
                }
            }
        }

        // Parse natural language input
        function parseInput(text) {
            const now = new Date();
            let date = new Date();
            let time = null;
            let title = text;

            // Extract time
            const timeMatch = text.match(/(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i);
            if (timeMatch) {
                let hours = parseInt(timeMatch[1]);
                const minutes = timeMatch[2] ? parseInt(timeMatch[2]) : 0;
                const meridiem = timeMatch[3];
                
                if (meridiem) {
                    if (meridiem.toLowerCase() === 'pm' && hours !== 12) hours += 12;
                    if (meridiem.toLowerCase() === 'am' && hours === 12) hours = 0;
                }
                
                time = { hours, minutes };
                title = text.replace(timeMatch[0], '').trim();
            }

            // Extract date
            const lower = text.toLowerCase();
            
            if (lower.includes('today')) {
                title = title.replace(/\btoday\b/i, '').trim();
            } else if (lower.includes('tomorrow')) {
                date.setDate(date.getDate() + 1);
                title = title.replace(/\btomorrow\b/i, '').trim();
            } else {
                const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const dayMatch = days.find(day => lower.includes(day));
                
                if (dayMatch) {
                    const targetDay = days.indexOf(dayMatch);
                    const currentDay = now.getDay();
                    let daysUntil = targetDay - currentDay;
                    if (daysUntil <= 0) daysUntil += 7;
                    
                    date.setDate(date.getDate() + daysUntil);
                    title = title.replace(new RegExp(dayMatch, 'i'), '').trim();
                }
                
                if (lower.includes('next week')) {
                    date.setDate(date.getDate() + 7);
                    title = title.replace(/\bnext week\b/i, '').trim();
                } else if (lower.includes('next')) {
                    date.setDate(date.getDate() + 7);
                    title = title.replace(/\bnext\b/i, '').trim();
                }
            }

            // Set time
            if (time) {
                date.setHours(time.hours, time.minutes, 0, 0);
            } else {
                date.setHours(now.getHours() + 1, 0, 0, 0);
            }

            // Clean title
            title = title.replace(/\bat\b/i, '').replace(/\s+/g, ' ').trim();

            return {
                title: title || 'Appointment',
                dateTime: date
            };
        }

        // Add appointment
        function addAppointment() {
            const input = document.getElementById('appointmentInput');
            const text = input.value.trim();
            
            if (!text) {
                debug('No text entered');
                return;
            }

            debug('Adding: ' + text);

            try {
                const parsed = parseInput(text);
                
                const appointment = {
                    id: Date.now(),
                    title: parsed.title,
                    dateTime: parsed.dateTime.toISOString()
                };

                appointments.push(appointment);
                debug('Created appointment: ' + appointment.title);
                
                saveAppointments();
                renderAppointments();
                
                input.value = '';
                debug('âœ“ Appointment added');
            } catch (e) {
                debug('âœ— Error: ' + e.message);
                alert('Error adding appointment: ' + e.message);
            }
        }

        // Delete appointment
        function deleteAppointment(id) {
            appointments = appointments.filter(apt => apt.id !== id);
            saveAppointments();
            renderAppointments();
            debug('Deleted appointment ' + id);
        }

        // Render appointments
        function renderAppointments() {
            const container = document.getElementById('appointmentsList');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);

            appointments.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            const upcoming = appointments.filter(apt => {
                const aptDate = new Date(apt.dateTime);
                return aptDate >= today && aptDate < nextWeek;
            });

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="empty-state">No appointments this week.<br>Add one above! ðŸŽ¯</div>';
                return;
            }

            container.innerHTML = upcoming.map(apt => {
                const aptDate = new Date(apt.dateTime);
                const isPast = aptDate < now;
                const isUpcoming = aptDate >= now && aptDate <= new Date(now.getTime() + 30 * 60000);
                
                return `
                    <div class="appointment-item ${isPast ? 'past' : ''} ${isUpcoming ? 'upcoming' : ''}">
                        <div class="appointment-info">
                            <div class="appointment-title">${apt.title}</div>
                            <div class="appointment-time">${formatDate(aptDate)} at ${formatTime(aptDate)}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteAppointment(${apt.id})">Delete</button>
                    </div>
                `;
            }).join('');
        }

        // Format date
        function formatDate(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const aptDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            if (aptDay.getTime() === today.getTime()) return 'Today';
            if (aptDay.getTime() === tomorrow.getTime()) return 'Tomorrow';
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()] + ', ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Format time
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        // Save to localStorage
        function saveAppointments() {
            try {
                localStorage.setItem('appointments', JSON.stringify(appointments));
                debug('Saved ' + appointments.length + ' appointments');
            } catch (e) {
                debug('âœ— Save failed: ' + e.message);
            }
        }

        // Load from localStorage
        function loadAppointments() {
            try {
                const stored = localStorage.getItem('appointments');
                if (stored) {
                    appointments = JSON.parse(stored);
                    debug('Loaded ' + appointments.length + ' appointments');
                } else {
                    debug('No saved appointments');
                }
            } catch (e) {
                debug('âœ— Load failed: ' + e.message);
                appointments = [];
            }
        }

        // Start app when page loads
        window.addEventListener('load', init);

        // Refresh display every minute
        setInterval(renderAppointments, 60000);
    </script>
</body>
</html>
